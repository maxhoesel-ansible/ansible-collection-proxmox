# maxhoesel.proxmox.pbs_client

Installs and configures the Proxmox backup client on a supported system.

The client is installed and configured for usage by the root user.
Additionally, a backup job can be configured and scheduled.

## Requirements

- Supported distros:
    - Debian 11, 12, 13
    - Ubuntu LTS 22.04, 24.04
- Root access via `become: yes` or equivalent

## Role Variables

#### `pbs_client_configure_backup`
- Whether to configure a backup task
- If `false`, the PBS client will be installed with no further configuration done
- Default: `true`

#### `pbs_client_skip_install`
- When to `true`, this role will not attempt to install the backup client and instead just assume that it is already present.
- This is useful if you already installed the backup client manually
- Default: `false`

### General configuration

#### `pbs_client_repository`
- Repository to backup to
- Format: `[[username@]server[:port]:]datastore`
- Example: `apps@pbs!mytoken@backuphost.example.org:datastore`
- Required: If `pbs_client_configure_backup` is `true`

#### `pbs_client_fingerprint`
- Fingerprint of the backup servers certificate
- Used to verify self-signed certificates, not needed if your backup server has a valid CA certificate that is trusted by the client.
- Default: not defined

#### `pbs_client_password`
- Password or Token secret to authenticate with when talking to the backup server
- Required: If `pbs_client_configure_backup` is `true`

### Backup Settings

#### `pbs_client_backup_archives`
- List of archive specifications as passed to the `backup` subcommand.
- An archive specification has the format `name.type:/path`
- Common types are `.pxar` and `.img`
- Example: `["fs.pxar:/"]` will create a file-based pxar archive of the root file system
- Required: If `pbs_client_configure_backup` is `true`

#### `pbs_client_include_mountpoints`
- Include the following mountpoints into the backup
- Must be a list of paths or `all`
  - If set to a list, items must be paths as passed to the `--include-dev` flag (see (here)[https://pbs.proxmox.com/docs/backup-client.html#creating-backups])
  - If set to `all`, the `--all-file-systems` flag will be used to include all mounted filesystems in the path
- Default: `[]`

#### `pbs_client_backup_id`
- Unique ID used to identify this backup group (see (here)[https://pbs.proxmox.com/docs/terminology.html#backup-group])
- If undefined, the PBS default (hostname) is used
- Default: not defined

### Encryption

---

**WARNING!**

Before you enable encryption, make sure to familiarize yourself with the way PBS handles encryption keys and passwords (see [here](https://pbs.proxmox.com/docs/backup-client.html#encryption)).
All encryption modes require you to somehow save the encryption keyfile/private key to a separate machine.
**The backup will become irrecoverable if you do not have a copy of the encryption key!**

---

#### `pbs_client_encryption_mode`
- Select the type of client-side encryption that should be used to encrypt backups on the remote server
- Note that this does not affect the backup transport security - PBS always uses TLS connections for transferring your backup.
- Choices: `none`, `keyfile`, `rsa`
  - `none`: No encryption is used
  - `keyfile`: An AES-256 encryption key is generated and saved on the client. This key is used to encrypt every backup archive
    - Please make sure to backup this keyfile to an external location. **You will not be able to restore from backup without this key!**
    - The key is stored without password protection to enable automatic backups.
  - `rsa`: Same as above, but a RSA public key is used to encrypt the backup keyfile, which is then appended to every backup.
    - This allows you to restore from a backup with the private key and without needing to know the AES keyfile. This is especially useful if you want to reuse an existing RSA keypair.
    - Please make sure to keep a copy of the private key corresponding to the public key around. **You will not be able to restore from backup without this key!**
- Default: `none`

#### `pbs_client_encryption_pubkey`
- Public RSA key to use for encrypting the backup key
- Must be in the string representation generated by PBS (`-----BEGIN PUBLIC KEY-----`...)
- Required: If `pbs_client_encryption_mode` is `rsa`

### Scheduling

#### `pbs_client_schedule`
- Time at which to run the backup job, specified as a [systemd time expression](https://www.freedesktop.org/software/systemd/man/systemd.time.html#)
- Examples: `daily`, `Mon..Sun 1:30:00 UTC`
- Default: `daily`

#### `pbs_client_schedule_name`
- Name of the systemd timer and unitfile that will be used to run the backup job
- Default: `proxmox-backup-client`

#### `pbs_client_schedule_randomdelay`
- Random delay in seconds before the backup actually starts. Useful to prevent bursts of backup traffic from multiple hosts.
- Default: `1800` (30 minutes)

#### `pbs_client_schedule_persistent`
- Whether the backup task should be started immediately if the task did not run the previous time, for example because the host was shut down
- Default: `true`

#### `pbs_client_schedule_require_ac`
- Whether the backup should be skipped if no AC power is present.
- This should work on all modern systems, but it is set to `false` by default just to be sure.
- Default: `false`

### Error Handling

#### `pbs_client_on_error_units`
- List of systemd units to be started if the backup task fails
- Example: `["mail-notify@i.service"]`
- Default: `[]`

## Example Playbook

```yaml
- hosts: all
  become: yes
  tasks:
    - name: Setup PBS Client
      include_role:
        name: maxhoesel.proxmox.pbs_client
      vars:
        # General settings
        pbs_client_repository: max@pbs@backup.example.org:datastore1
        pbs_client_password: user-password-for-the-backup-server
        pbs_client_backup_archives:
          - "root.pxar:/"
        pbs_client_include_mountpoints:
          - /var/external-data
        pbs_client_backup_id: "{{ ansible_fqdn }}" # use the FQDN instead of just the hostname
        # Encryption
        pbs_client_encryption_mode: rsa
        pbs_client_encryption_pubkey: "{{ lookup('file', '~/pbs-pubkey.pem') }}"
        #

```
